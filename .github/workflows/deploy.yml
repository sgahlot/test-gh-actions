name: Deploy to OpenShift

on:
  workflow_run:
    # Workflows this workflow depends on
    workflows: ["Build and push image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Target namespace for deployment'
        required: false
        default: 'sgahlot-test'
        type: string
      force_deploy:
        description: 'Force deployment even if build workflow did not run'
        required: false
        default: false
        type: boolean

env:
  NAMESPACE: ${{ github.event.inputs.namespace || 'sgahlot-test' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run this workflow when:
    # 1. Build workflow completes successfully (automatic)
    # 2. Manually triggered (workflow_dispatch)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Determine target branch
        id: target-branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "target_branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
            echo "Using workflow_run head_branch: ${{ github.event.workflow_run.head_branch }}"
          else
            echo "target_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using current ref: ${{ github.ref_name }}"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}

      - name: Show branch and commit info
        run: |
          echo "::group::Repository Information"
          echo "Checked out branch: $(git branch --show-current)"
          echo "Target ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "::endgroup::"

      - name: Deploy metrics-summarizer with Makefile
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_API_KEY }}
          NAMESPACE: ${{ env.NAMESPACE }}
        run: |
          # Run make target from root dir
          echo "In branch: `git branch --show-current`"
          grep "^VERSION" Makefile
          echo "Grepping version/tag from values.yaml"
          find deploy -name "values.yaml" -exec grep -H 'tag: ' {} \;
