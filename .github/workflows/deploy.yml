name: Deploy to OpenShift

on:
  workflow_run:
    # Workflows this workflow depends on
    workflows: ["Build and push image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Target namespace for deployment (leave empty for auto-detect based on branch)'
        required: false
        default: ''
        type: string
      force_deploy:
        description: 'Force deployment even if build workflow did not run'
        required: false
        default: false
        type: boolean

env:
  # Determine namespace based on branch:
  # - Manual dispatch: use input namespace if provided
  # - workflow_run: use the branch name that triggered the workflow (head_branch)
  # - workflow_dispatch: use the current branch name (ref_name)
  # This ensures deployment to a namespace matching the target branch name
  NAMESPACE: ${{ github.event.inputs.namespace || (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name) }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run this workflow when:
    # 1. Build workflow completes successfully (automatic)
    # 2. Manually triggered (workflow_dispatch)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}

      - name: Show branch and commit info
        run: |
          echo "::group::Repository Information"
          echo "Checked out branch: $(git branch --show-current)"
          echo "Target ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Target namespace: ${{ env.NAMESPACE }}"
          echo "::endgroup::"

      - name: Install OpenShift CLI
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          oc: 4

      - name: Login to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true # Set to false if we have a valid certificate

      - name: Deploy metrics-summarizer with Makefile
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_API_KEY }}
          NAMESPACE: ${{ env.NAMESPACE }}
        run: |
          # Run make target from root dir
          echo "Running make install LLM_URL=http://llama-3-1-8b-instruct-predictor.dev.svc.cluster.local..."
          echo "NAMESPACE=$NAMESPACE"

