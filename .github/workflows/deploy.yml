name: Deploy to OpenShift

on:
  workflow_run:
    # Workflows this workflow depends on
    workflows: ["Build and push image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      namespace:
        description: 'Target namespace for deployment'
        required: false
        default: 'sgahlot-test'
        type: string
      force_deploy:
        description: 'Force deployment even if build workflow did not run'
        required: false
        default: false
        type: boolean

env:
  NAMESPACE: ${{ github.event.inputs.namespace || 'sgahlot-test' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run this workflow when:
    # 1. Build workflow completes successfully (automatic)
    # 2. Manually triggered (workflow_dispatch)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Determine target branch
        id: target-branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "Workflow run event detected"
            echo "Original head_branch: ${{ github.event.workflow_run.head_branch }}"
            echo "Original head_sha: ${{ github.event.workflow_run.head_sha }}"
            
            # Use the commit SHA to determine which branch contains this commit
            TARGET_SHA="${{ github.event.workflow_run.head_sha }}"
            echo "Checking which branches contain commit: $TARGET_SHA"
            
            # Check if the commit exists in dev branch
            git ls-remote origin dev | grep -q "$TARGET_SHA" && echo "target_branch=dev" >> $GITHUB_OUTPUT && echo "Found commit in dev branch" && exit 0
            
            # Check if the commit exists in main branch  
            git ls-remote origin main | grep -q "$TARGET_SHA" && echo "target_branch=main" >> $GITHUB_OUTPUT && echo "Found commit in main branch" && exit 0
            
            # Fallback to the original head_branch
            echo "target_branch=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
            echo "Using fallback head_branch: ${{ github.event.workflow_run.head_branch }}"
          else
            echo "target_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "Using current ref: ${{ github.ref_name }}"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.target-branch.outputs.target_branch }}

      - name: Show branch and commit info
        run: |
          echo "::group::Repository Information"
          echo "Target Branch: ${{ steps.target-branch.outputs.target_branch }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "Workflow Run Head Branch: ${{ github.event.workflow_run.head_branch }}"
            echo "Workflow Run Head SHA: ${{ github.event.workflow_run.head_sha }}"
          fi
          echo "::endgroup::"

      - name: Deploy metrics-summarizer with Makefile
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_API_KEY }}
          NAMESPACE: ${{ env.NAMESPACE }}
        run: |
          # Run make target from root dir
          grep "^VERSION" Makefile
          echo "Grepping version/tag from values.yaml"
          find deploy -name "values.yaml" -exec grep -H 'tag: ' {} \;
